# 0.2 索引



## 2.1 键值存储与关系型数据库

尽管关系型数据库支持多种查询类型，但实际上几乎所有查询都可以归结为三种磁盘操作类型：
1. 扫描整个数据集。（未使用索引）
2. 点查询：通过特定键查询索引。
3. 范围查询：通过范围查询索引。（索引是排序的）

数据库索引主要涉及范围查询和点查询，很明显，范围查询只是点查询的扩展集。如果我们提取数据库索引的功能，很容易就可以实现一个键值存储。但关键在于，可以在键值存储的基础上构建数据库系统。

在尝试构建关系型数据库之前，我们将先构建一个键值存储，不过首先让我们探索一下可选方案。



## 2.2 哈希表

在设计通用键值存储时，哈希表通常是第一个被排除的选项。主要原因在于排序——许多实际应用确实需要排序和有序性。

然而，在特定应用中使用哈希表是可行的。使用哈希表的另一个困扰是扩容操作。简单的扩容操作是O(n)，会导致磁盘空间和I/O突然增加。虽然可以逐步地扩容哈希表，但这会增加实现的复杂性。



## 2.3 B-树

平衡二叉树可以在O(log(n))时间内进行查询和更新，并且支持范围查询。B-树大致上是一种平衡的n叉树。为什么使用n叉树而不是二叉树呢？有几个原因：

1. 较少的空间开销。

  在二叉树中，每个叶节点都需要通过父节点的指针到达，而父节点可能也有自己的父节点。平均来看，每个叶节点需要1到2个指针。
  相比之下，B-树中多个数据共用一个父节点，而且n叉树也更短。在指针上浪费的空间更少。

2. 内存中更快。

  由于现代CPU内存缓存和其他因素，即使它们的大O复杂度相同，n叉树也可能比二叉树更快。

3. 减少磁盘I/O。

   - B-树更短，意味着需要较少的磁盘寻道次数。

   - 磁盘I/O的最小单位通常是内存页的大小（可能是4K）。即便只需要读取更小的尺寸，操作系统也会填充整个4K页。如果充分利用4K页中的所有信息（通过选择至少为一页大小的节点大小），这是最理想的。


本书中我们将使用B-树。但B-树并非唯一的选择。



## 2.4 LSM树（日志结构合并树）

以下是LSM-Tree操作的高层次概述。如何查询：
1. LSM-Tree包含多级数据。
2. 每一级都是排序的，并被分割成多个文件。
3. 点查询从顶层开始，如果找不到键，则继续向下一层搜索。
4. 范围查询合并所有层级的结果，较高层级在合并时具有更高优先级。

如何更新：
5. 更新键时，首先将键插入顶层的文件中。
6. 如果文件大小超过阈值，将其与下一层合并。
7. 文件大小的阈值随着层级的增加呈指数增长，这意味着数据量也呈指数级增长。

我们来分析这一过程的工作原理。对于查询：
1. 每一层都是排序的，可以通过二分查找找到键，范围查询仅需顺序文件I/O，效率较高。

对于更新：
2. 顶层文件较小，因此插入顶层所需I/O量较少。
3. 数据最终会合并到更低的层级。合并操作是顺序I/O，这是一个优点。
4. 更高层级触发合并更为频繁，但每次合并的数据量较小。
5. 当将文件合并到更低层级时，任何范围相交的低层文件都会被合并结果（可能是多个文件）替换。这就是为什么层级被分割成多个文件的原因——为了减少合并的规模。
6. 合并操作可以在后台进行。然而，低层级的合并可能会突然导致较高的I/O使用率，从而影响系统性能。

读者在完成本书后可以尝试使用LSM树替代B树，并对比B树与LSM树之间的优缺点。