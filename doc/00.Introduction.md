<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [00.简介](#00%E7%AE%80%E4%BB%8B)
  - [0.1 这本书的目的](#01-%E8%BF%99%E6%9C%AC%E4%B9%A6%E7%9A%84%E7%9B%AE%E7%9A%84)
  - [0.2 如何使用本书？](#02-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%9C%AC%E4%B9%A6)
  - [0.3 主题一：持久性](#03-%E4%B8%BB%E9%A2%98%E4%B8%80%E6%8C%81%E4%B9%85%E6%80%A7)
  - [0.4 主题二：索引](#%E4%B8%BB%E9%A2%98%E4%BA%8C%E7%B4%A2%E5%BC%95)
  - [0.5 主题三：并发](#%E4%B8%BB%E9%A2%98%E4%B8%89%E5%B9%B6%E5%8F%91)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# 00.简介

## 0.1 这本书的目的

数据库并非黑箱，通过从零开始构建自己的数据库来深入了解它们吧！本书逐步介绍了构建一个极简型持久化数据库的过程。这里对数据库的实现是逐步累加的，从B-树开始，到简单的键值存储，最终发展成一个微型的关系型数据库。

本书着重于核心思想而非具体实现细节。现实世界中的数据库复杂且难以掌握，通过简化版的数据库学习，可以更快、更容易地理解其精髓。而且，“从零开始”的方法迫使你深入学习每一个环节。

尽管本书简短且实现内容精简，但它旨在涵盖三个重要主题：
1. 持久性。如何避免数据丢失或损坏，以及如何在系统崩溃后恢复数据。
2. 索引。如何高效地查询和操作数据。（使用B-树技术）。
3. 并发。如何处理多个（大量）客户端的访问请求，以及事务管理。

如果你对数据库只有模糊的概念，比如“数据库储存我的数据”或“索引速度快”，那么这本书非常适合你。

## 0.2 如何使用本书？

本书采取逐步引导的方式，每一步都建立在前一步的基础之上，并引入新的概念。书中使用的示例代码语言为Golang，但所讨论的主题并不限定于特定编程语言，具有普遍适用性。建议读者在阅读文本的同时，亲自编写自己的数据库版本，通过实践加深理解。

草稿章节可于官方网站查阅：
[](https://build-your-own.org)

## 0.3 主题一：持久性

为什么需要数据库？为什么不直接将数据直接存放到文件中呢？我们讨论的第一个主题就是探讨数据的持久性。

假设程序在向文件写入数据的过程中崩溃，或者遭遇断电，此时的文件状态会怎么样呢？

- 文件是否会仅仅丢失最后一次的写入？

- 还是会留下一个只写了一半的文件？

- 甚至处于更加损坏的状态？ 

以上任何一种情况都有可能发生。当简单地向文件写入数据时，并不能保证数据一定能在磁盘上持久保存。这是数据库需要解决的问题。而且，数据库在遭遇意外关闭后重启时，能够恢复到可用状态。

在不使用数据库的前提下，能够实现持久化呢？答案是有的，方法如下：

1. 将整个更新后的数据集写入一个新的文件中
2. 对新文件调用fsync，确保数据被同步到磁盘
3. 通过将新文件重新命名为旧文件的方式来覆盖旧文件。这一操作由文件系统保证是原子性的，即要么全部完成，要么完全不执行。

这种方法仅在数据集很小的情况下才可行。像SQLite这样的数据库能够进行增量更新，处理更大的数据集时更为高效和灵活。

## 04 主题二：索引

数据库查询大致可以分为两种不同的类型：分析型（OLAP）和事务型（OLTP）。
- **分析型（OLAP）查询**通常涉及大量数据，伴随着聚合、分组或连接操作。
- 相比之下，**事务型（OLTP）查询**通常只触及少量经过索引的数据。最常见的查询类型包括基于索引的点查询和基于索引的范围查询。

需要注意的是，“事务型”这个词并不直接关联于你可能已知的数据库事务概念。计算机术语常常承载多重含义。本书仅聚焦于OLTP相关技术。

尽管许多应用程序并非实时系统，但大多数面向用户的软件应当在合理（小）的时间内响应，并且使用合理数量的资源（如内存、I/O）。这属于OLTP范畴。如何在数据集庞大时迅速找到数据（以O(log(n))的时间复杂度）？这就是我们为何需要索引的原因。索引能够在大规模数据集中高效定位所需数据，确保用户交互的及时性与效率。

如果暂不考虑持久性方面，并假设数据集能够完全存放在内存中，那么快速查找数据就变成了数据结构问题。在数据库系统中，将数据存储在磁盘上并用于查找数据的数据结构被称为“索引”。并且，数据库的索引可以比内存容量大。有句话说：如果问题能够被内存容纳，那就是一个简单的问题。

常用的索引数据结构包括B-树和LSM树。

## 05 主题三：并发

现代应用程序不仅顺序执行所有操作，数据库也是如此。并发存在多个层面：
- 读之间的并发。
- 读与写之间的并发，写入者是否需要对数据库的独占访问？

即使是基于文件的SQLite也支持一定程度的并发。但在进程内部实现并发更为容易，这也是大多数数据库系统只能通过“服务器”访问的原因之一。

随着并发性的增加，应用程序往往需要以原子性执行操作，比如读取-修改-写入操作。这为数据库引入了一个新概念：事务。事务确保了一系列操作要么全部完成，要么全部不起作用，以此来维护数据的一致性和完整性。